function jsCoordinateConverter(){}function ENPoint(a){this.east=a.getXAxis(),this.north=a.getYAxis()}function lonLatPoint(a){this.lon=a.getXAxis(),this.lat=a.getYAxis()}Math.deg2Rad=function(a){return a*Math.PI/180},Math.rad2Deg=function(a){return 180*a/Math.PI},jsCoordinateConverter.Utility={invertSign:function(a){if(!isNaN(parseFloat(a))&&isFinite(a)){var b=a*-1;return b}return a},recursiveLoop:function(a,b){for(var c in a)a.hasOwnProperty(c)&&("object"==typeof a[c]?this.recursiveLoop(a[c],b):a[c]=jsCoordinateConverter.Utility[b](a[c]));return a}};var Coordinates=function(){var a=0,b=0,c=0;if(this.constructor===Coordinates)throw new Error("Cannot create and instance of an abstract class");this.setCoordinates=function(d,e,f){if(this.isNumeric=function(a){return!isNaN(parseFloat(a))&&isFinite(a)},!this.isNumeric(d))throw new Error("x-Axis must be numeric");if(a=d,!this.isNumeric(e))throw new Error("y-Axis must be numeric");if(b=e,!this.isNumeric(f))throw new Error("z-Axis must be numeric");c=f},this.getXAxis=function(){return a},this.getYAxis=function(){return b},this.getZAxis=function(){return c}},eastNorthValues=function(a,b,c){Coordinates.apply(this,arguments),this.setCoordinates(a,b,c)};eastNorthValues.prototype=Object.create(Coordinates.prototype),eastNorthValues.prototype.constructor=eastNorthValues;var lonLatValues=function(a,b,c){Coordinates.apply(this,arguments),this.setCoordinates(a,b,c)};lonLatValues.prototype=Object.create(Coordinates.prototype),lonLatValues.prototype.constructor=lonLatValues;var xyzValues=function(a,b,c){Coordinates.apply(this,arguments),this.setCoordinates(a,b,c)};xyzValues.prototype=Object.create(Coordinates.prototype),xyzValues.prototype.constructor=xyzValues;var projectionConstants={OSNG:{F0:.9996012717,lat0:49,lon0:-2,N0:-1e5,E0:4e5}},ellipsoidConstants={AIRY_1830:{a:6377563.396,b:6356256.909},GRS80:{a:6378137,b:6356752.3141},WGS_84:{a:6378137,b:6356752.3141}},datumConstants={OSGB36:{name:"Ordnance Survey - Great Britain (1936)",synonyms:"OSGB",epsg_id:"4277",esri_name:"D_OSGB_1936",defaultRegion:"GB_Great_Britain",referenceEllipsoid:"AIRY_1830",regions:{GB_Great_Britain:{translationVectors:{x:-446.448,y:125.157,z:-542.06},translationVectorsUOM:"meters",rotationMatrix:{x:-.1502,y:-.247,z:-.8421},rotationMatrixUOM:"ARCSECONDS",scaleFactor:20.4894}}},WGS84:{name:"WGS 1984",epsg_id:"4326",esri_name:"D_WGS_1984",defaultRegion:"Global_Definition",referenceEllipsoid:"WGS_84",regions:{Global_Definition:{translationVectors:{x:0,y:0,z:0},translationVectorsUOM:"meters",rotationMatrix:{x:0,y:0,z:0},rotationMatrixUOM:"ARCSECONDS",scaleFactor:0}}}};jsCoordinateConverter.TranMerConversion=function(){},jsCoordinateConverter.TranMerConversion.prototype.meridionalArc=function(a,b,c,d,e){var f=(1+c+5/4*Math.pow(c,2)+5/4*Math.pow(c,3))*(d-e),g=(3*c+3*Math.pow(c,2)+21/8*Math.pow(c,3))*Math.sin(d-e)*Math.cos(d+e),h=(15/8*Math.pow(c,2)+15/8*Math.pow(c,3))*Math.sin(2*(d-e))*Math.cos(2*(d+e)),i=35/24*Math.pow(c,3)*Math.sin(3*(d-e))*Math.cos(3*(d+e)),j=a*b*(f-g+h-i);return j},jsCoordinateConverter.TranMerConversion.prototype.eccentricitySquared=function(a,b){var c=1-Math.pow(b,2)/Math.pow(a,2);return c},jsCoordinateConverter.TranMerConversion.prototype.latLonToEN=function(a,b,c){var d=projectionConstants[b],e=ellipsoidConstants[c],f=Math.deg2Rad(a.getXAxis()),g=Math.deg2Rad(a.getYAxis()),h=d.F0,i=Math.deg2Rad(d.lon0),j=Math.deg2Rad(d.lat0),k=d.N0,l=d.E0,m=e.a,n=e.b,o=this.eccentricitySquared(m,n),p=(m-n)/(m+n),q=Math.cos(g),r=Math.sin(g),s=Math.tan(g),t=m*h*Math.pow(1-o*Math.pow(r,2),-.5),u=m*h*(1-o)*Math.pow(1-o*Math.pow(r,2),-1.5),v=t/u-1,w=this.meridionalArc(n,h,p,g,j),x=w+k,y=t/2*r*q,z=t/24*r*Math.pow(q,3)*(5-Math.pow(s,2)+9*v),A=t/720*r*Math.pow(q,5)*(61-58*Math.pow(s,2)+Math.pow(s,4)),B=t*q,C=t/6*Math.pow(q,3)*(t/u-Math.pow(s,2)),D=t/120*Math.pow(q,5)*(5-18*Math.pow(s,2)+Math.pow(s,4)+14*v-58*Math.pow(s,2)*v),E=f-i,F=x+y*Math.pow(E,2)+z*Math.pow(E,4)+A*Math.pow(E,6),G=l+B*E+C*Math.pow(E,3)+D*Math.pow(E,5);return new eastNorthValues(G,F,0)},jsCoordinateConverter.TranMerConversion.prototype.enToLonLat=function(a,b,c){var d=a.getXAxis(),e=a.getYAxis(),f=projectionConstants[b],g=ellipsoidConstants[c],h=g.a,i=g.b,j=f.F0,k=Math.deg2Rad(f.lat0),l=Math.deg2Rad(f.lon0),m=f.N0,n=f.E0,o=this.eccentricitySquared(h,i),p=(h-i)/(h+i),q=k,r=this.meridionalArc(i,j,p,q,k);do q=(e-m-r)/(h*j)+q,r=this.meridionalArc(i,j,p,q,k);while(e-m-r>=1e-5);var s=Math.cos(q),t=Math.sin(q),u=Math.tan(q),v=h*j*Math.pow(1-o*Math.pow(t,2),-.5),w=h*j*(1-o)*Math.pow(1-o*Math.pow(t,2),-1.5),x=v/w-1,y=u/(2*w*v),z=u/(24*w*Math.pow(v,3))*(5+3*Math.pow(u,2)+x-9*Math.pow(u,2)*x),A=u/(720*w*Math.pow(v,5))*(61+90*Math.pow(u,2)+45*Math.pow(u,4)),B=1/s/v,C=1/s/(6*Math.pow(v,3))*(v/w+2*Math.pow(u,2)),D=1/s/(120*Math.pow(v,5))*(5+28*Math.pow(u,2)+24*Math.pow(u,4)),E=1/s/(5040*Math.pow(v,7))*(61+662*Math.pow(u,2)+1320*Math.pow(u,4)+720*Math.pow(u,6)),F=q-y*Math.pow(d-n,2)+z*Math.pow(d-n,4)-A*Math.pow(d-n,6),G=l+B*(d-n)-C*Math.pow(d-n,3)+D*Math.pow(d-n,5)-E*Math.pow(d-n,7);return new lonLatValues(Math.rad2Deg(G),Math.rad2Deg(F),0)},jsCoordinateConverter.DatumReference=function(a,b){function c(a){var b;if("undefined"==typeof a)throw new Error("No region name set");var c=d;if(!datumConstants[c].regions[a])throw new Error(a+" is not a valid region for this datum");b=datumConstants[c].regions[a],h={translationVectors:b.translationVectors,rotationMatrix:b.rotationMatrix,scaleFactor:b.scaleFactor}}var d,e,f,g,h;this.setDatum=function(a,b){var h;if("undefined"==typeof datumConstants[a])throw new Error(a+" is not a valid datum");return h=datumConstants[a],"undefined"!=typeof b&&null!==b||(b=h.defaultRegion),d=a,e=h.name,f=h.referenceEllipsoid,g=ellipsoidConstants[f],c(b),this},this.getDatumReference=function(){return d},this.getEllipsoid=function(){return g},this.getHelmertParameters=function(){return h},"undefined"==typeof a?this.setDatum("WGS84",null):this.setDatum(a,b)},jsCoordinateConverter.DatumConversion=function(a){return"undefined"==typeof a?"A source datum must be set":(this._fromDatum=new jsCoordinateConverter.DatumReference(a),this._fromEllipsoid=this._fromDatum.getEllipsoid(),void(this.TranMerConversion=new jsCoordinateConverter.TranMerConversion))},jsCoordinateConverter.DatumConversion.prototype.getFromDatum=function(){return _fromDatum},jsCoordinateConverter.DatumConversion.prototype.convert=function(a,b){this._toDatum=new jsCoordinateConverter.DatumReference(b),this._toEllipsoid=this._toDatum.getEllipsoid();var c=new jsCoordinateConverter.DatumReference("WGS84");this._fromDatum.getDatumReference()==c.getDatumReference()&&(this._toHelmert=this._toDatum.getHelmertParameters()),this._toDatum.getDatumReference()==c.getDatumReference()&&(this._toHelmert=this._fromDatum.getHelmertParameters(),this._toHelmert=jsCoordinateConverter.Utility.recursiveLoop(this._toHelmert,"invertSign")),void 0===this._toHelmert&&(a=this.convert(a,"WGS84"),this._toHelmert=this._toDatum.getHelmertParameters());var d=this.toCartesian(a),e=this.helmertTransformation(d.getXAxis(),d.getYAxis(),d.getZAxis(),this._toHelmert),f=this.fromCartesian(e);return f},jsCoordinateConverter.DatumConversion.prototype.toCartesian=function(a){var b=Math.deg2Rad(a.getXAxis()),c=Math.deg2Rad(a.getYAxis()),d=a.getZAxis(),e=this._fromEllipsoid.a,f=this._fromEllipsoid.b,g=this.TranMerConversion.eccentricitySquared(e,f),h=Math.sin(c),i=Math.cos(c),j=Math.sin(b),k=Math.cos(b),l=e/Math.sqrt(1-g*Math.pow(h,2)),m=(l+d)*i*k,n=(l+d)*i*j,o=(l*(1-g)+d)*h;return new xyzValues(m,n,o)},jsCoordinateConverter.DatumConversion.prototype.fromCartesian=function(a){for(var b=a.getXAxis(),c=a.getYAxis(),d=a.getZAxis(),e=this._toEllipsoid.a,f=this._toEllipsoid.b,g=this.TranMerConversion.eccentricitySquared(e,f),h=Math.atan2(c,b),i=e/Math.sqrt(1-g*Math.pow(Math.sin(c),2)),j=Math.sqrt(Math.pow(b,2)+Math.pow(c,2)),k=Math.atan2(d,j*(1-g));Math.abs(c-k)>4/e;)c=k,i=e/Math.sqrt(1-g*Math.pow(Math.sin(c),2)),k=Math.atan2(d+g*i*Math.sin(c),j);var l=j/Math.cos(k)-i;return h=Math.rad2Deg(h),k=Math.rad2Deg(k),new lonLatValues(h,k,l)},jsCoordinateConverter.DatumConversion.prototype.helmertTransformation=function(a,b,c,d){var e=d.translationVectors.x,f=d.translationVectors.y,g=d.translationVectors.z,h=Math.deg2Rad(d.rotationMatrix.x/3600),i=Math.deg2Rad(d.rotationMatrix.y/3600),j=Math.deg2Rad(d.rotationMatrix.z/3600),k=d.scaleFactor/1e6,l=e+a*(1+k)-b*j+c*i,m=f+a*j+b*(1+k)-c*h,n=g-a*i+b*h+c*(1+k);return new xyzValues(l,m,n)},jsCoordinateConverter.OSNGConversions=function(){},jsCoordinateConverter.OSNGConversions.prototype.gridrefLetToNum=function(a){var b=a.toUpperCase().charCodeAt(0)-"A".charCodeAt(0),c=a.toUpperCase().charCodeAt(1)-"A".charCodeAt(0);b>7&&b--,c>7&&c--;var d=(b-2)%5*5+c%5,e=19-5*Math.floor(b/5)-Math.floor(c/5);switch(a=a.slice(2).replace(/ /g,""),d+=a.slice(0,a.length/2),e+=a.slice(a.length/2),a.length){case 6:d+="50",e+="50";break;case 8:d+="5",e+="5"}return[parseInt(d),parseInt(e)]},jsCoordinateConverter.OSNGConversions.prototype.gridrefNumToLet=function(a,b,c){var d=Math.floor(a/1e5),e=Math.floor(b/1e5);if(d<0||d>6||e<0||e>12)return"";var f=19-e-(19-e)%5+Math.floor((d+10)/5),g=5*(19-e)%25+d%5;f>7&&f++,g>7&&g++;var h=String.fromCharCode(f+"A".charCodeAt(0),g+"A".charCodeAt(0));a=Math.floor(a%1e5/Math.pow(10,5-c/2)),b=Math.floor(b%1e5/Math.pow(10,5-c/2));var i=h+" "+a.padLZ(c/2)+" "+b.padLZ(c/2);return i},Number.prototype.padLZ=function(a){for(var b=this.toString(),c=b.length,d=0;d<a-c;d++)b="0"+b;return b};